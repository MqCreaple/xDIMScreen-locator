<!--
  -- This HTML document creates a fractal apriltag pattern (which I doubt if it's actually useful).
  --
  -- This page uses [chaitanyantr](https://github.com/chaitanyantr)'s apriltag SVG generator.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fractal Apriltag</title>
    <script>
        const mappings = {
            "tag16h5": {
                "file_prefix": "tag16_05_",
                "viewBox": "0 0 80 80",
                "tag_size_ratio": 6/8
            },
            "tag25h9": {
                "file_prefix": "tag25_09_",
                "viewBox": "0 0 90 90",
                "tag_size_ratio": 7/9
            },
            "tag36h11": {
                "file_prefix": "tag36_11_",
                "viewBox": "0 0 100 100",
                "tag_size_ratio": 8/10,
            },
            "tagCircle21h7": {
                "file_prefix": "tag21_07_",
                "viewBox": "0 0 90 90",
                "tag_size_ratio": 1.0
            },
            "tagCircle49h12": {
                "file_prefix": "tag49_12_",
                "viewBox": "0 0 110 110",
                "tag_size_ratio": 1.0
            },
            "tagCustom48h12": {
                "file_prefix": "tag48_12_",
                "viewBox": "0 0 100 100",
                "tag_size_ratio": 6/10,
            },
            "tagStandard41h12": {
                "file_prefix": "tag41_12_",
                "viewBox": "0 0 90 90",
                "tag_size_ratio": 5/9,
            },
            "tagStandard52h13": {
                "file_prefix": "tag52_13_",
                "viewBox": "0 0 100 100",
                "tag_size_ratio": 6/10
            }
        };
        async function getSVGContentFromURL(url){
            const res = await fetch(url);
            const content = await res.text();
            return content;
        }

        var counter = {
            "tag16h5": 0,
            "tag25h9": 0,
            "tag36h11": 0,
        };
        const CHILD_OFFSET = [
            [1.0, -0.5],
            [-0.5, -0.5],
            [-0.5, 1.0],
            [1.0, 1.0]
        ];
        async function addSvg(svg, lvl, maxLvl, family, curPos, curStat, tagSize) {
            if(lvl >= maxLvl) {
                return;
            }
            // curStat: -1 = the biggest tag, 0 = upright, 1 = upleft, 2 = bottomleft, 3 = bottomright
            let id_str = counter[family].toString();
            counter[family] += 1;
            while(id_str.length < 5){
                id_str = "0" + id_str
            }
            let tagFileName = mappings[family].file_prefix + id_str + ".svg";
            let url = `https://raw.githubusercontent.com/chaitanyantr/apriltag/main/${family}/${tagFileName}`;
            let contentStr = await getSVGContentFromURL(url);
            let node = document.createRange().createContextualFragment(contentStr).firstElementChild.cloneNode(true);
            node.id = family + "-" + id_str;
            node.setAttribute("viewBox", mappings[family].viewBox);
            node.setAttribute("x", curPos[0]);
            node.setAttribute("y", curPos[1]);
            node.setAttribute("width", tagSize);
            node.setAttribute("height", tagSize);
            svg.appendChild(node);
            
            // depth first search
            for(let childStat = 0; childStat < 4; childStat++) {
                if(curStat != -1 && (childStat - curStat + 4) % 4 == 2) {
                    continue;
                }
                let childPos = [...curPos];
                childPos[0] += CHILD_OFFSET[childStat][0] * tagSize;
                childPos[1] += CHILD_OFFSET[childStat][1] * tagSize;
                let newFamily = family;
                if(lvl >= 1) {
                    newFamily = "tag16h5";
                } else if(lvl >= 0) {
                    newFamily = "tag25h9";
                }
                addSvg(svg, lvl + 1, maxLvl, newFamily, childPos, childStat, tagSize / 2);
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            let lvl = 3;
            let centralTagSize = 60;   // unit: mm
            let svg = document.getElementById("target");
            svg.setAttribute("width", (centralTagSize * 3) + "mm");
            svg.setAttribute("height", (centralTagSize * 3) + "mm");
            svg.setAttribute("viewBox", `0 0 ${(centralTagSize * 3)} ${(centralTagSize * 3)}`);  // to ensure that the viewbox unit matches millimeter
            addSvg(svg, 0, 3, "tag36h11", [centralTagSize, centralTagSize], -1, centralTagSize);
        });
    </script>
</head>
<body>
    <div id="root">
        <svg id="target" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
</body>
</html>